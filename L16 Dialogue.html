<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, landscape=yes">
    <title>ç¯å¢ƒä¿æŠ¤å¯¹è¯ - XUSFUNCHINESE</title>
    <style>
        :root {
            --primary: #01579b; --accent: #e1f5fe; --gold: #fbc02d;
            --pinyin: #ff0000; --night-sky: radial-gradient(circle at center, #001f3f 0%, #000510 100%);
        }
        body { margin: 0; font-family: "Arial", sans-serif; background: linear-gradient(135deg, #0277bd 0%, #002f6c 100%); height: 100vh; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        /* é‡‘å…‰é—ªé—ªçš„Cover */
        #cover-page {
            position: fixed; top:0; left:0; width:100%; height:100%; background:var(--night-sky);
            z-index:5000; display:flex; flex-direction:column; justify-content:center; align-items:center; cursor:pointer;
        }
        .shiny-title {
            font-size: 10vw; font-weight: 900; text-align: center;
            background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 10px rgba(255,215,0,0.5));
            animation: shine 3s infinite linear; line-height: 1.1;
        }
        @keyframes shine { 0% { background-position: 0%; } 100% { background-position: 200%; } }

        @keyframes confettiFall {
            0% { top: -10vh; transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { top: 110vh; transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        header { background: rgba(255,255,255,0.95); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 100; }
        .nav-btns button { padding: 8px 15px; margin-right: 5px; border-radius: 20px; border: 2px solid var(--primary); cursor: pointer; font-weight: bold; background: white; color: var(--primary); font-size: 13px; }
        .active-mode { background: var(--primary) !important; color: white !important; }
        
        main { flex: 1; display: flex; padding: 20px; gap: 15px; overflow: hidden; position: relative; }
        #left-panel { flex: 0.7; background: rgba(255,255,255,0.95); border-radius: 30px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 4px solid var(--accent); position: relative; }
        #right-panel { flex: 1.3; background: rgba(255,255,255,0.95); border-radius: 30px; padding: 25px; overflow-y: auto; border: 4px solid var(--accent); }
        
        .dialogue-box { margin-bottom: 20px; padding: 15px; border-radius: 12px; background: #fff; border-left: 6px solid var(--primary); cursor: pointer; transition: 0.2s; text-align: center; }
        .dialogue-box:hover { background: #f0faff; }
        
        ruby { font-size: 26px; font-weight: 600; margin: 0 3px; display: inline-flex; flex-direction: column-reverse; align-items: center; }
        rt { font-size: 14px; color: var(--pinyin); font-weight: bold; margin-bottom: 4px; }
        
        #list-container, #quiz-container { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 200; overflow-y: auto; padding: 40px; box-sizing: border-box; }
        .quiz-option { width: 100%; padding: 15px; margin: 8px 0; border: 2px solid var(--primary); border-radius: 12px; background: white; cursor: pointer; font-size: 18px; font-weight: bold; }
        
        #timer-bar { position: absolute; top: 0; left: 0; height: 8px; background: #ff5252; width: 0%; transition: width 0.1s linear; border-radius: 4px; }
        .watermark { position: fixed; bottom: 10px; right: 20px; color: rgba(255,255,255,0.4); font-weight: bold; font-style: italic; pointer-events: none; z-index: 1000; }
    </style>
</head>
<body>

<div id="cover-page" onclick="enterApp()">
    <div class="shiny-title">ç¯ä¿<br>å¯¹è¯</div>
    <p style="color:white; margin-top: 30px; letter-spacing: 2px;">CLICK TO START</p>
</div>

<div class="watermark">XUSFUNCHINESE</div>

<header>
    <div class="nav-btns">
        <button onclick="setMode('study')" id="btn-study" class="active-mode">ğŸ“– å­¦ä¹ </button>
        <button onclick="setMode('quiz')" id="btn-quiz">ğŸ“ æµ‹è¯•</button>
        <button onclick="setMode('rush')" id="btn-rush" style="border-color: #ff5252; color: #ff5252;">âš¡ RUSH</button>
        <button onclick="setMode('mistake')" id="btn-mistake" style="border-color: #7b1fa2; color: #7b1fa2;">âŒ é”™é¢˜æœ¬(<span id="mistake-count">0</span>)</button>
        <button onclick="setMode('list')" id="btn-list">ğŸ“œ åˆ—è¡¨</button>
    </div>
    <div id="stat-display" style="font-weight: bold;">è¿›åº¦: <span id="progress-text">1</span>/<span id="total-groups">20</span></div>
</header>

<main>
    <div id="study-ui" style="display: flex; width: 100%; height: 100%; gap: 15px;">
        <div id="left-panel">
            <div id="timer-bar"></div>
            <div id="emoji-display" style="font-size: 100px;">ğŸ”ï¸</div>
            <button onclick="playCurrentCard()" style="margin-top:20px; padding:15px 30px; border-radius:30px; background:var(--primary); color:white; border:none; cursor:pointer; font-weight:bold;">ğŸ”Š æœ—è¯»å½“å‰å¡</button>
            <div id="rush-score-ui" style="display:none; margin-top:10px; font-size:24px; color:red; font-weight:bold;">å¾—åˆ†: <span id="rush-score">0</span></div>
            <div style="margin-top:30px; display:flex; gap:10px;">
                <button onclick="prev()" style="padding:10px 20px; border-radius:10px;">â—€</button>
                <button onclick="next()" style="background:var(--gold); border:none; padding:10px 20px; font-weight:bold; border-radius:10px;">â–¶</button>
            </div>
        </div>
        <div id="right-panel"><div id="content-area"></div></div>
    </div>
    <div id="list-container">
        <button onclick="setMode('study')" style="position:absolute; top:10px; right:10px; padding:10px; background:red; color:white; border:none; border-radius:5px; z-index:10;">å…³é—­</button>
        <div id="list-content"></div>
    </div>
    <div id="quiz-container">
        <div id="quiz-content" style="max-width: 600px; margin: 0 auto; text-align: center;">
            <h2 id="quiz-title">æµ‹è¯•æ¨¡å¼</h2>
            <div id="quiz-prompt" style="font-size:24px; margin:20px 0; padding:25px; background:#f0f7ff; border-radius:15px; border:2px solid var(--primary);"></div>
            <div id="quiz-options"></div>
        </div>
    </div>
</main>

<script>
    const database = [
        {
            emoji: "ğŸ”ï¸",
            lines: [
                {cn: "å¼ å¤©æ˜ä»–ä»¬å››ä¸ªäººæ¥åŒ—äº¬å·²ç»ä¸¤ä¸‰ä¸ªæœˆäº†ï¼Œå¤©æ°”ä¹Ÿé€æ¸æš–å’Œäº†ã€‚", py: "ZhÄng TiÄnmÃ­ng tÄmen sÃ¬ gÃ¨ rÃ©n lÃ¡i BÄ›ijÄ«ng yÇjÄ«ng liÇng sÄn ge yuÃ¨ le, tiÄnqÃ¬ yÄ› zhÃºjiÃ n nuÇnhuo le.", en: "Zhang Tianming and the other three have been in Beijing for two or three months, and the weather has gradually become warmer."},
                {cn: "ä»–ä»¬æ¯å¤©ä¸Šè¯¾çš„ä¸Šè¯¾ï¼Œæ‰¾å·¥ä½œçš„æ‰¾å·¥ä½œï¼ŒåŠä¸ªæœˆæ²¡è§é¢äº†ã€‚", py: "tÄmen mÄ›itiÄn shÃ ngkÃ¨ de shÃ ngkÃ¨, zhÇo gÅngzuÃ² de zhÇo gÅngzuÃ², bÃ n ge yuÃ¨ mÃ©i jiÃ nmiÃ n le.", en: "Some attend classes every day, others look for jobs, and they haven't seen each other for half a month."},
                {cn: "ä»Šå¤©æ˜¯æ˜ŸæœŸå…­ï¼Œå¤§å®¶éƒ½æƒ³è½»æ¾è½»æ¾ï¼Œå¤©æ˜å»ºè®®å»çˆ¬å±±ã€‚", py: "jÄ«ntiÄn shÃ¬ xÄ«ngqÄ«liÃ¹, dÃ jiÄ dÅu xiÇng qÄ«ngsÅng qÄ«ngsÅng, TiÄnmÃ­ng jiÃ nyÃ¬ qÃ¹ pÃ¡shÄn.", en: "Today is Saturday, everyone wants to relax a bit. Tianming suggests going mountain climbing."},
                {cn: "ä¸½èå’Œé›ªæ¢…ä¸åå¯¹ï¼ŒæŸ¯æ—ä¹Ÿè§‰å¾—è¿™ä¸ªå»ºè®®ä¸é”™ã€‚", py: "LÃ¬shÄ hÃ© XuÄ›mÃ©i bÃ¹ fÇnduÃ¬, KÄ“lÃ­n yÄ› juÃ©de zhÃ¨ge jiÃ nyÃ¬ bÃ¹cuÃ².", en: "Lisa and Xuemei do not oppose it, and Colin also thinks the suggestion is good."},
                {cn: "ä»–è¯´æ­£å¥½ä»–çš„å¾·å›½æœ‹å‹é©¬å…‹ä¹Ÿæƒ³å»ã€‚", py: "tÄ shuÅ zhÃ¨nghÇo tÄ de DÃ©guÃ³ pÃ©ngyou MÇkÃ¨ yÄ› xiÇng qÃ¹.", en: "He says his German friend Mark also wants to go."},
                {cn: "å¯æ˜¯æ€ä¹ˆå»å‘¢ï¼Ÿåå‡ºç§Ÿè½¦å§ï¼Œå¤ªè´µï¼Œè€Œä¸”ä¹Ÿæ²¡æ„æ€ã€‚", py: "kÄ›shÃ¬ zÄ›nme qÃ¹ ne? zuÃ² chÅ«zÅ«chÄ“ ba, tÃ i guÃ¬, Ã©rqiÄ› yÄ› mÃ©i yÃ¬si.", en: "But how should we go? Taking a taxi is too expensive and not interesting."},
                {cn: "åå…¬äº¤è½¦å§ï¼Œäººå¤ªå¤šï¼Œå¤ªæŒ¤ã€‚", py: "zuÃ² gÅnggÃ²ngqÃ¬chÄ“ ba, rÃ©n tÃ i duÅ, tÃ i jÇ.", en: "Taking the bus has too many people and is too crowded."},
                {cn: "æŸ¯æ—æƒ³å‡ºäº†ä¸€ä¸ªä¸»æ„ï¼Œéª‘è‡ªè¡Œè½¦ï¼", py: "KÄ“lÃ­n xiÇngchÅ«le yÄ« ge zhÇ”yi, qÃ­ zÃ¬xÃ­ngchÄ“!", en: "Colin came up with an idea: ride bicycles!"},
                {cn: "å¤§å®¶é©¬ä¸Šå°±åŒæ„äº†ï¼Œè§‰å¾—éª‘è‡ªè¡Œè½¦åˆèƒ½é”»ç‚¼èº«ä½“ï¼Œåˆçœé’±ï¼Œè€Œä¸”æœ‰ç›Šäºç¯å¢ƒä¿æŠ¤ã€‚", py: "dÃ jiÄ mÇshÃ ng jiÃ¹ tÃ³ngyÃ¬ le, juÃ©de qÃ­ zÃ¬xÃ­ngchÄ“ yÃ²u nÃ©ng duÃ nliÃ n shÄ“ntÇ, yÃ²u shÄ›ng qiÃ¡n, Ã©rqiÄ› yÇ’uyÃ¬ yÃº huÃ¡njÃ¬ng bÇohÃ¹.", en: "Everyone immediately agreed, thinking that riding bicycles can exercise the body, save money, and is beneficial to environmental protection."},
                {cn: "ä»–ä»¬æ—©ä¸Šå¾ˆæ—©å°±å‡ºå‘äº†ã€‚", py: "tÄmen zÇoshang hÄ›n zÇo jiÃ¹ chÅ«fÄ le.", en: "They set off very early in the morning."},
                {cn: "éª‘äº†å¾ˆé•¿çš„ä¸€æ®µè·¯ä»¥åï¼Œæœ‰ç‚¹çƒ­ï¼Œä¹Ÿæœ‰ç‚¹ç´¯ï¼Œå°±ä¸‹äº†è½¦ï¼Œä¸€è¾¹æ¨ç€è½¦ï¼Œä¸€è¾¹èŠäº†èµ·æ¥ã€‚", py: "qÃ­ le hÄ›n chÃ¡ng de yÄ« duÃ n lÃ¹ yÇhÃ²u, yÇ’udiÇn rÃ¨, yÄ› yÇ’udiÇn lÃ¨i, jiÃ¹ xiÃ  le chÄ“, yÄ«biÄn tuÄ«zhe chÄ“, yÄ«biÄn liÃ¡o le qÇlai.", en: "After riding a long stretch, they felt a bit hot and tired, so they got off the bikes and chatted while pushing them."},
                {cn: "è¿™å„¿çš„ç©ºæ°”æ¯”åŸé‡Œå¥½ï¼Œé›¾éœ¾ä¹Ÿæ²¡æœ‰é‚£ä¹ˆä¸¥é‡ã€‚", py: "zhÃ¨r de kÅngqÃ¬ bÇ chÃ©nglÇ hÇo, wÃ¹mÃ¡i yÄ› mÃ©iyÇ’u nÃ me yÃ¡nzhÃ²ng.", en: "The air here is better than in the city, and the smog is not so severe."},
                {cn: "åˆ°å¤„éƒ½æ˜¯ç»¿è‰²ï¼Œçœ‹ç€çœŸèˆ’æœï¼", py: "dÃ ochÃ¹ dÅu shÃ¬ lÇœsÃ¨, kÃ nzhe zhÄ“n shÅ«fu!", en: "Everywhere is green; it looks really comfortable!"},
                {cn: "å“å‘€ï¼Œæ¸´æ­»äº†ï¼Œä½ ä»¬çœ‹ï¼Œä¸€ç“¶æ°´éƒ½å–å®Œäº†ï¼", py: "ÄiyÄ, kÄ› sÇ le, nÇmen kÃ n, yÄ« pÃ­ng shuÇ dÅu hÄ“ wÃ¡n le!", en: "Oh no, I'm dying of thirst. Look, the bottle of water is all gone!"},
                {cn: "è¿™å„¿æœ‰åƒåœ¾å›æ”¶ç­’å—ï¼Ÿç©ºç“¶å­ä¸èƒ½éšä¾¿ä¹±æ‰”ã€‚", py: "zhÃ¨r yÇ’u lÄjÄ« huÃ­shÅu tÇ’ng ma? kÅng pÃ­ngzi bÃ¹ nÃ©ng suÃ­biÃ n luÃ n rÄ“ng.", en: "Is there a recycling bin here? We can't just throw empty bottles anywhere."},
                {cn: "å¯¹ï¼Œæˆ‘ä»¬åº”è¯¥æ³¨æ„ç¯ä¿ï¼Œåƒåœ¾å›æ”¶ç­’ï¼Œä½ çœ‹ï¼Œåœ¨æ ‘ä¸‹è¾¹ã€‚", py: "duÃ¬, wÇ’men yÄ«nggÄi zhÃ¹yÃ¬ huÃ¡nbÇo, lÄjÄ« huÃ­shÅu tÇ’ng, nÇ kÃ n, zÃ i shÃ¹ xiÃ bian.", en: "Yes, we should pay attention to environmental protection. The recycling binâ€”look, it's under the tree."},
                {cn: "æˆ‘å¥½ä¹…æ²¡ä¹°ç“¶è£…æ°´äº†ã€‚", py: "wÇ’ hÇojiÇ” mÃ©i mÇi pÃ­ngzhuÄng shuÇ le.", en: "I haven't bought bottled water for a long time."},
                {cn: "æˆ‘ä»¬ç­æœ‰çš„åŒå­¦å»ºè®®ï¼Œä¸ºäº†ä¿æŠ¤ç»¿è‰²çš„åœ°çƒï¼Œè‡ªå·±å¸¦æ°´å–ï¼Œä¸ä¹°ç“¶è£…æ°´ã€‚", py: "wÇ’men bÄn yÇ’u de tÃ³ngxuÃ© jiÃ nyÃ¬, wÃ¨ile bÇohÃ¹ lÇœsÃ¨ de dÃ¬qiÃº, zÃ¬jÇ dÃ i shuÇ hÄ“, bÃ¹ mÇi pÃ­ngzhuÄng shuÇ.", en: "Some classmates in our class suggest bringing our own water to protect the green Earth and not buying bottled water."},
                {cn: "è¿™ä¸ªå»ºè®®ä¸é”™ã€‚", py: "zhÃ¨ge jiÃ nyÃ¬ bÃ¹cuÃ².", en: "This suggestion is good."},
                {cn: "å“ï¼Œä½ ä»¬çœ‹ï¼Œé‚£è¾¹æˆ¿å­ä¸Šæœ‰äº›äº®äº®çš„ä¸œè¥¿ï¼Œæ˜¯ä»€ä¹ˆï¼Ÿ", py: "Äi, nÇmen kÃ n, nÃ biÄn fÃ¡ngzi shÃ ng yÇ’u xiÄ“ liÃ ngliÃ ng de dÅngxi, shÃ¬ shÃ©nme?", en: "Hey, look over there on the roofâ€”what are those shiny things?"},
                {cn: "æ˜¯å¤ªé˜³èƒ½æ¿å§ï¼Ÿæˆ‘åœ¨ç¾å›½ä¹Ÿçœ‹è§è¿‡ã€‚", py: "shÃ¬ tÃ iyÃ¡ngnÃ©ng bÇn ba? wÇ’ zÃ i MÄ›iguÃ³ yÄ› kÃ njiÃ nguo.", en: "Solar panels, right? I've seen them in America too."},
                {cn: "ç”¨å¤ªé˜³èƒ½å‘ç”µï¼Œå¤ªå¥½äº†ï¼", py: "yÃ²ng tÃ iyÃ¡ngnÃ©ng fÄdiÃ n, tÃ i hÇo le!", en: "Using solar energy to generate electricity is great!"},
                {cn: "è¦æ˜¯è‡ªè¡Œè½¦ä¹Ÿèƒ½ç”¨å¤ªé˜³èƒ½å‘ç”µï¼Œé‚£å¤šé…·å•Šï¼", py: "yÃ oshi zÃ¬xÃ­ngchÄ“ yÄ› nÃ©ng yÃ²ng tÃ iyÃ¡ngnÃ©ng fÄdiÃ n, nÃ  duÅ kÃ¹ a!", en: "If bicycles could use solar power too, how cool that would be!"},
                {cn: "ç°åœ¨ä¸–ç•Œä¸Šå¾ˆå¤šå›½å®¶éƒ½æœ‰èƒ½æºå±æœºã€‚", py: "xiÃ nzÃ i shÃ¬jiÃ¨ shÃ ng hÄ›n duÅ guÃ³jiÄ dÅu yÇ’u nÃ©ngyuÃ¡n wÄ“ijÄ«.", en: "Many countries in the world now have energy crises."},
                {cn: "å¦‚æœä¸–ç•Œå„å›½éƒ½ç”¨å¤ªé˜³èƒ½å’Œé£èƒ½ï¼Œé‚£èƒ½èŠ‚çº¦å¤šå°‘çŸ³æ²¹å’Œç…¤å•Šï¼è€Œä¸”å¤šç¯ä¿ï¼å“ˆå“ˆâ€¦â€¦", py: "rÃºguÇ’ shÃ¬jiÃ¨ gÃ¨guÃ³ dÅu yÃ²ng tÃ iyÃ¡ngnÃ©ng hÃ© fÄ“ngnÃ©ng, nÃ  nÃ©ng jiÃ©yuÄ“ duÅshÇo shÃ­yÃ³u hÃ© mÃ©i a! Ã©rqiÄ› duÅ huÃ¡nbÇo! hÄhÄâ€¦â€¦", en: "If all countries used solar and wind energy, how much oil and coal could be saved! And how environmentally friendly! Haha..."},
                {cn: "æˆ‘å¬è¯´ä¸­å›½æ”¿åºœè§„å®šåŠå…¬å®¤å’Œå…¬å…±åœºæ‰€ï¼Œå†¬å¤©æš–æ°”çš„æ¸©åº¦ä¸èƒ½é«˜äºæ‘„æ°20åº¦ï¼Œå¤å¤©ç©ºè°ƒçš„æ¸©åº¦ä¸èƒ½ä½äº26åº¦ã€‚", py: "wÇ’ tÄ«ngshuÅ ZhÅngguÃ³ zhÃ¨ngfÇ” guÄ«dÃ¬ng bÃ ngÅngshÃ¬ hÃ© gÅnggÃ²ng chÇngsuÇ’, dÅngtiÄn nuÇnqÃ¬ de wÄ“ndÃ¹ bÃ¹ nÃ©ng gÄoyÃº ShÃ¨shÃ¬ Ã¨rshÃ­ dÃ¹, xiÃ tiÄn kÅngtiÃ¡o de wÄ“ndÃ¹ bÃ¹ nÃ©ng dÄ«yÃº Ã¨rshÃ­liÃ¹ dÃ¹.", en: "I heard the Chinese government stipulates that in offices and public places, heating in winter cannot exceed 20 degrees Celsius, and air conditioning in summer cannot be below 26 degrees."},
                {cn: "è¿™ä¸ªè§„å®šæˆ‘ä¸¾åŒæ‰‹èµæˆã€‚", py: "zhÃ¨ge guÄ«dÃ¬ng wÇ’ jÇ” shuÄngshÇ’u zÃ nchÃ©ng.", en: "I support this regulation with both hands."},
                {cn: "ä½ ä»¬è¿˜è®°å¾—å—ï¼Œæˆ‘ä»¬ç¾å›½å­¦æ ¡çš„æ•™å®¤ï¼Œå†¬å¤©ç©¿è¡¬è¡«è¿˜å‡ºæ±—ï¼Œå¤å¤©ç©¿æ¯›è¡£è¿˜å†·å¾—ä¸å¾—äº†ã€‚", py: "nÇmen hÃ¡i jÃ¬de ma, wÇ’men MÄ›iguÃ³ xuÃ©xiÃ o de jiÃ oshÃ¬, dÅngtiÄn chuÄn chÃ¨nshÄn hÃ¡i chÅ«hÃ n, xiÃ tiÄn chuÄn mÃ¡oyÄ« hÃ¡i lÄ›ng de bÃ¹dÃ©liÇo.", en: "Do you remember our American school classrooms? In winter we'd sweat in shirts, in summer we'd freeze in sweaters."},
                {cn: "å¯ä¸æ˜¯å—ï¼Œå¤ªæµªè´¹äº†ã€‚", py: "kÄ› bÃ¹shÃ¬ ma, tÃ i lÃ ngfÃ¨i le.", en: "Exactly, it's too wasteful."},
                {cn: "æˆ‘å¬è¯´ç°åœ¨ä¸å°‘äººå»é¤å…åƒé¥­è‡ªå·±å¸¦é¤å…·ï¼Œä¸ç”¨ä¸€æ¬¡æ€§çš„ã€‚", py: "wÇ’ tÄ«ngshuÅ xiÃ nzÃ i bÃ¹shÇo rÃ©n qÃ¹ cÄntÄ«ng chÄ«fÃ n zÃ¬jÇ dÃ i cÄnjÃ¹, bÃ¹ yÃ²ng yÃ­cÃ¬xÃ¬ng de.", en: "I heard many people now bring their own tableware to restaurants and don't use disposable ones."},
                {cn: "æˆ‘è§‰å¾—è¿™ä¸ªåšæ³•å¾ˆå¥½ï¼Œè¦ä¸ç„¶æ¯å¹´è¦ç å¤šå°‘æ ‘å•Šï¼Ÿ", py: "wÇ’ juÃ©de zhÃ¨ge zuÃ²fÇ hÄ›n hÇo, yÃ obÃ¹rÃ¡n mÄ›iniÃ¡n yÃ o kÇn duÅshÇo shÃ¹ a?", en: "I think this is great; otherwise, how many trees would be cut down each year?"},
                {cn: "é™¤äº†ä¸Šé¤é¦†è‡ªå·±å¸¦ç­·å­ï¼Œä¹°ä¸œè¥¿ä¹Ÿå¾—è‡ªå·±å¸¦åŒ…äº†ã€‚", py: "chÃºle shÃ ng cÄnguÇn zÃ¬jÇ dÃ i kuÃ izi, mÇi dÅngxi yÄ› dÄ›i zÃ¬jÇ dÃ i bÄo le.", en: "Besides bringing chopsticks to restaurants, you also need to bring your own bag for shopping."},
                {cn: "å¯¹ï¼Œç°åœ¨ä¸­å›½è¶…å¸‚ä¸ç»™å¡‘æ–™è¢‹ï¼Œè¦è‡ªå·±ä¹°ï¼Œæ‰€ä»¥å¾ˆå¤šäººéƒ½è‡ªå·±å¸¦åŒ…ï¼Œè¿™æ ·ä¸€å¹´ä¸çŸ¥é“èƒ½å‡å°‘å¤šå°‘ç™½è‰²æ±¡æŸ“ï¼", py: "duÃ¬, xiÃ nzÃ i ZhÅngguÃ³ chÄoshÃ¬ bÃ¹ gÄ›i sÃ¹liÃ o dÃ i, yÃ o zÃ¬jÇ mÇi, suÇ’yÇ hÄ›n duÅ rÃ©n dÅu zÃ¬jÇ dÃ i bÄo, zhÃ¨yÃ ng yÄ« niÃ¡n bÃ¹ zhÄ«dÃ o nÃ©ng jiÇnshÇo duÅshÇo bÃ¡isÃ¨ wÅ«rÇn!", en: "Yes, now Chinese supermarkets don't provide plastic bagsâ€”you have to buy themâ€”so many people bring their own, reducing who knows how much white pollution in a year!"},
                {cn: "è¿˜æœ‰æ±½è½¦ï¼Œä¸ä½†è¦ç”¨å¾ˆå¤šèƒ½æºï¼Œè€Œä¸”è¿˜å¯¹ç©ºæ°”é€ æˆä¸¥é‡æ±¡æŸ“ã€‚", py: "hÃ¡i yÇ’u qÃ¬chÄ“, bÃ¹dÃ n yÃ o yÃ²ng hÄ›n duÅ nÃ©ngyuÃ¡n, Ã©rqiÄ› hÃ¡i duÃ¬ kÅngqÃ¬ zÃ ochÃ©ng yÃ¡nzhÃ²ng wÅ«rÇn.", en: "And cars not only use a lot of energy but also cause serious air pollution."},
                {cn: "å¤§å®¶éƒ½åº”è¯¥åƒæˆ‘ä»¬è¿™æ ·ï¼Œå°‘å¼€è½¦ã€å¤šéª‘è½¦ã€å¤šèµ°è·¯ï¼Œåˆç¯ä¿èŠ‚èƒ½ã€åˆæœ‰ç›Šäºå¥åº·ã€‚", py: "dÃ jiÄ dÅu yÄ«nggÄi xiÃ ng wÇ’men zhÃ¨yÃ ng, shÇo kÄichÄ“, duÅ qÃ­chÄ“, duÅ zÇ’ulÃ¹, yÃ²u huÃ¡nbÇo jiÃ© nÃ©ng, yÃ²u yÇ’uyÃ¬ yÃº jiÃ nkÄng.", en: "Everyone should be like us: drive less, ride bikes and walk moreâ€”it's environmentally friendly, saves energy, and is good for health."},
                {cn: "å¯¹ï¼Œåœ°çƒæ˜¯æˆ‘ä»¬çš„å®¶ï¼Œæˆ‘ä»¬åº”è¯¥å¥½å¥½ä¿æŠ¤å®ƒï¼", py: "duÃ¬, dÃ¬qiÃº shÃ¬ wÇ’men de jiÄ, wÇ’men yÄ«nggÄi hÇohÇo bÇohÃ¹ tÄ!", en: "Yes, the Earth is our home; we should protect it well!"},
                {cn: "æˆ‘ä»¬åº”è¯¥ä»å°åœ°æ–¹åšèµ·ï¼Œæ¯”å¦‚éšæ‰‹å…³ç¯ï¼ŒèŠ‚çº¦ç”¨æ°´ã€‚", py: "wÇ’men yÄ«nggÄi cÃ³ng xiÇo dÃ¬fang zuÃ²qÇ, bÇrÃº suÃ­shÇ’u guÄn dÄ“ng, jiÃ©yuÄ“ yÃ²ng shuÇ.", en: "We should start from small things, like turning off lights when leaving and saving water."},
                {cn: "å¥½ï¼åŒæ„ï¼", py: "hÇo! tÃ³ngyÃ¬!", en: "Good! Agreed!"},
                {cn: "å“ï¼Œä½ ä»¬çœ‹ï¼Œéƒ½åˆ°äº†å±±ä¸‹äº†ã€‚æˆ‘ä»¬å¼€å§‹çˆ¬å±±å§ï¼Œçœ‹è°å…ˆåˆ°å±±ä¸Šï¼åŠ æ²¹ï¼", py: "Äi, nÇmen kÃ n, dÅu dÃ o le shÄnxiÃ  le. wÇ’men kÄishÇ pÃ¡shÄn ba, kÃ n shuÃ­ xiÄn dÃ o shÄn shÃ ng! jiÄyÃ³u!", en: "Hey, look, we've reached the foot of the mountain. Let's start climbingâ€”see who gets to the top first! Come on!"}
            ]
        }
    ];

    let currentIndex = 0, currentMode = 'study', score = 0, timer = null;
    let mistakes = [];
    const numGroups = Math.ceil(database[0].lines.length / 2);
    document.getElementById('total-groups').innerText = numGroups;

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playTone(freq, duration) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    }

    function launchConfetti() {
        const colors = ['#f00', '#0f0', '#00f', '#ff0', '#f0f', '#0ff'];
        for (let i = 0; i < 150; i++) {
            const p = document.createElement('div');
            p.innerText = ['ğŸ‰','ğŸŒŸ','âœ¨','ğŸŠ','ğŸ’¥'][Math.floor(Math.random()*5)];
            p.style.position = 'fixed';
            p.style.left = Math.random() * 100 + 'vw';
            p.style.top = '-10vh';
            p.style.fontSize = (Math.random() * 20 + 20) + 'px';
            p.style.color = colors[Math.floor(Math.random() * colors.length)];
            p.style.pointerEvents = 'none';
            p.style.zIndex = '10000';
            p.style.animation = 'confettiFall ' + (Math.random() * 3 + 4) + 's linear forwards';
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 7000);
        }
    }

    function initStars() {
        const container = document.getElementById('star-container');
        for(let i=0; i<100; i++) {
            let s = document.createElement('div'); s.className = 'star';
            s.style.setProperty('--angle', Math.random() * 360 + 'deg');
            s.style.animationDuration = Math.random() * 1.5 + 0.8 + 's';
            container.appendChild(s);
        }
    }

    function generateRuby(text, pinyin) {
        const chars = text.split('');
        const pyWords = pinyin.split(' ');
        let html = '';
        let pyIdx = 0;
        chars.forEach(c => {
            if(/[\u4e00-\u9fa5]/.test(c)) {
                html += `<ruby>${c}<rt>${pyWords[pyIdx] || ''}</rt></ruby>`;
                pyIdx++;
            } else {
                html += c;
            }
        });
        return html;
    }

    function render() {
        const start = currentIndex * 2;
        const cardLines = database[0].lines.slice(start, start + 2);
        document.getElementById('emoji-display').innerText = database[0].emoji;
        document.getElementById('progress-text').innerText = currentIndex + 1;

        let html = '';
        cardLines.forEach((line, idx) => {
            const speaker = (start + idx) % 4 < 2 ? 'å™è¿°ï¼š' : 'å¯¹è¯ï¼š';
            html += `
                <div class="dialogue-box" id="card-line-${idx}">
                    <div style="font-weight:bold; color:var(--primary); margin-bottom:10px;">${speaker}</div>
                    <div style="font-size:26px; margin:15px 0;">${line.cn}</div>
                    <p style="color:#888; font-size:16px; text-align:center;">ç‚¹å‡»æ˜¾ç¤ºæ‹¼éŸ³å’Œè‹±æ–‡ç¿»è¯‘</p>
                </div>`;
        });
        document.getElementById('content-area').innerHTML = html;

        cardLines.forEach((line, idx) => {
            const box = document.getElementById(`card-line-${idx}`);
            box.onclick = () => {
                const speaker = (start + idx) % 4 < 2 ? 'å™è¿°ï¼š' : 'å¯¹è¯ï¼š';
                box.innerHTML = `
                    <div style="font-weight:bold; color:var(--primary); margin-bottom:10px;">${speaker}</div>
                    <div style="font-size:26px; margin:15px 0;">${generateRuby(line.cn, line.py)}</div>
                    <div style="font-size:18px; color:#666; font-style:italic; margin-top:10px;">${line.en}</div>`;
                box.onclick = null;
                box.style.cursor = 'default';
                speakLine(line.cn);
            };
        });
    }

    function playCurrentCard() {
        const start = currentIndex * 2;
        const cardLines = database[0].lines.slice(start, start + 2);
        window.speechSynthesis.cancel();
        let delay = 0;
        cardLines.forEach(line => {
            setTimeout(() => speakLine(line.cn), delay);
            delay += line.cn.length * 60 + 800;
        });
    }

    function speakLine(text) {
        window.speechSynthesis.cancel();
        const ut = new SpeechSynthesisUtterance(text);
        ut.lang = 'zh-CN';
        ut.rate = 0.85;
        window.speechSynthesis.speak(ut);
    }

    function setMode(mode) {
        currentMode = mode;
        clearInterval(timer);
        document.getElementById('timer-bar').style.width = '0%';
        document.getElementById('rush-score-ui').style.display = 'none';
        document.querySelectorAll('.nav-btns button').forEach(b => b.classList.remove('active-mode'));
        ['study-ui','list-container','quiz-container'].forEach(id => document.getElementById(id).style.display = 'none');

        if(mode === 'study') {
            document.getElementById('btn-study').classList.add('active-mode');
            document.getElementById('study-ui').style.display = 'flex';
            render();
        } else if(['quiz','rush','mistake'].includes(mode)) {
            document.getElementById(`btn-${mode === 'mistake' ? 'mistake' : mode}`).classList.add('active-mode');
            document.getElementById('quiz-container').style.display = 'block';
            if(mode === 'rush') {
                score = 0;
                document.getElementById('rush-score-ui').style.display = 'block';
                document.getElementById('rush-score').innerText = 0;
                startRushTimer();
            }
            startQuiz();
        } else if(mode === 'list') {
            document.getElementById('btn-list').classList.add('active-mode');
            document.getElementById('list-container').style.display = 'block';
            renderList();
        }
    }

    function startRushTimer() {
        let t = 30; // æ”¹ä¸º30ç§’
        timer = setInterval(() => {
            t--;
            document.getElementById('timer-bar').style.width = ((30 - t)/30 * 100) + '%';
            if(t <= 0) {
                clearInterval(timer);
                playEncouragement("æ—¶é—´åˆ°ï¼æœ€ç»ˆå¾—åˆ†: " + score);
                launchConfetti();
                setMode('study');
            }
        }, 1000);
    }

    function startQuiz() {
        const allLines = database[0].lines;
        let line;
        if(currentMode === 'mistake') {
            if(mistakes.length === 0) {
                playEncouragement("é”™é¢˜å…¨éƒ¨ç­”å¯¹ï¼å¤ªæ£’äº†ï¼");
                launchConfetti();
                setMode('study');
                return;
            }
            line = mistakes[0];
        } else {
            line = allLines[Math.floor(Math.random() * allLines.length)];
        }
        const isZh = Math.random() > 0.5;
        document.getElementById('quiz-prompt').innerText = isZh ? line.cn : line.en;

        let opts = [line];
        while(opts.length < 4) {
            let r = allLines[Math.floor(Math.random() * allLines.length)];
            if(!opts.some(o => o.cn === r.cn)) opts.push(r);
        }
        opts.sort(() => Math.random() - 0.5);

        document.getElementById('quiz-options').innerHTML = opts.map(o => `
            <button class="quiz-option" onclick="checkAnswer(this, '${o.cn.replace(/'/g, "\\'")}', '${line.cn.replace(/'/g, "\\'")}')">${isZh ? o.en : o.cn}</button>
        `).join('');
    }

    function checkAnswer(btn, selected, correct) {
        if(selected === correct) {
            playTone(880, 0.2);
            btn.style.background = "#c8e6c9";
            if(currentMode === 'rush') {
                score++;
                document.getElementById('rush-score').innerText = score;
            }
            if(currentMode === 'mistake') {
                mistakes.shift();
                updateMistakeCount();
                if(mistakes.length === 0) {
                    setTimeout(() => {
                        playEncouragement("é”™é¢˜å…¨éƒ¨ç­”å¯¹ï¼æ­å–œä½ ï¼");
                        launchConfetti();
                        setMode('study');
                    }, 800);
                    return;
                }
            }
            setTimeout(startQuiz, 800);
        } else {
            playTone(220, 0.4);
            btn.style.background = "#ffcdd2";
            if(currentMode !== 'mistake') {
                const wrongLine = database[0].lines.find(l => l.cn === correct);
                if(wrongLine && !mistakes.some(m => m.cn === correct)) {
                    mistakes.push(wrongLine);
                    updateMistakeCount();
                }
            }
        }
    }

    function updateMistakeCount() {
        document.getElementById('mistake-count').innerText = mistakes.length;
    }

    function playEncouragement(text = "") {
        const msgs = ["ä½ å¤ªæ£’äº†ï¼", "ç»§ç»­åŠ æ²¹ï¼", "çœŸå‰å®³ï¼", "å¤ªæ£’äº†ï¼Œç»§ç»­ä¿æŒï¼"];
        speakText(text + msgs[Math.floor(Math.random() * msgs.length)]);
    }

    function renderList() {
        let html = '<h2>ğŸ“œ ç¯å¢ƒä¿æŠ¤å¯¹è¯ï¼ˆåˆ†ç»„å¡ç‰‡ï¼‰</h2>';
        for(let i = 0; i < numGroups; i++) {
            const firstLine = database[0].lines[i*2].cn.substring(0, 35) + (database[0].lines[i*2].cn.length > 35 ? '...' : '');
            html += `
                <div style="padding:15px; border-bottom:1px solid #eee; cursor:pointer;" onclick="currentIndex = ${i}; setMode('study');">
                    <span style="font-size:24px;">ğŸ”ï¸</span> <b>ç¬¬${i+1}å¡ï¼š${firstLine}</b>
                </div>`;
        }
        document.getElementById('list-content').innerHTML = html;
    }

    function next() {
        currentIndex = (currentIndex + 1) % numGroups;
        render();
    }

    function prev() {
        currentIndex = (currentIndex - 1 + numGroups) % numGroups;
        render();
    }

    function enterApp() {
        document.getElementById('cover-page').style.display = 'none';
        render();
    }

    window.onload = () => { initStars(); };
</script>
</body>
</html>
